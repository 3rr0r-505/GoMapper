name: GoMapper CI/CD

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]

# ---------------------------
# 1️⃣ Static Code & Lint Scan
# ---------------------------
jobs:
  static-code-check:
    name: Static Code Check (Gosec + Lint)
    runs-on: ubuntu-latest
    if: github.ref_type != 'tag'
    outputs:
      summary: ${{ steps.gosec.outputs.summary }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Install Tools
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Gosec Scan
        id: gosec
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          gosec ./... -fmt=json -out=gosec_report.json || true
          if [ -f gosec_report.json ]; then
            HIGH=$(jq '[.Issues[] | select(.severity=="HIGH")] | length' gosec_report.json)
            MEDIUM=$(jq '[.Issues[] | select(.severity=="MEDIUM")] | length' gosec_report.json)
            LOW=$(jq '[.Issues[] | select(.severity=="LOW")] | length' gosec_report.json)
          else
            HIGH=0
            MEDIUM=0
            LOW=0
          fi
          echo "summary=High: $HIGH, Medium: $MEDIUM, Low: $LOW" >> $GITHUB_OUTPUT

      - name: Lint Check
        run: golangci-lint run || true

# ---------------------------
# 2️⃣ Dependency Vulnerability Scan (if go.sum exists)
# ---------------------------
  dependency-check:
    name: Dependency Check (govulncheck)
    runs-on: ubuntu-latest
    if: github.ref_type != 'tag'
    outputs:
      summary: ${{ steps.vulncheck.outputs.summary }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Install govulncheck
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck (only if go.sum exists)
        id: vulncheck
        run: |
          if [ -f go.sum ]; then
            export PATH=$PATH:$(go env GOPATH)/bin
            govulncheck ./... -json > govulncheck_report.json || true
            if [ -s govulncheck_report.json ] && jq empty govulncheck_report.json 2>/dev/null; then
              HIGH=$(jq '[.Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' govulncheck_report.json)
              MEDIUM=$(jq '[.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' govulncheck_report.json)
              LOW=$(jq '[.Vulnerabilities[]? | select(.Severity=="LOW")] | length' govulncheck_report.json)
            else
              HIGH=0
              MEDIUM=0
              LOW=0
            fi
          else
            HIGH=0
            MEDIUM=0
            LOW=0
          fi
          echo "summary=High: $HIGH, Medium: $MEDIUM, Low: $LOW" >> $GITHUB_OUTPUT

# ---------------------------
# 3️⃣ Combined Security Summary
# ---------------------------
  combined-summary:
    name: Combined Security Summary
    runs-on: ubuntu-latest
    if: github.ref_type != 'tag'
    needs:
      - static-code-check
      - dependency-check
    steps:
      - name: Show Combined Results
        run: |
          echo "=== Static Code Check ==="
          echo "${{ needs.static-code-check.outputs.summary }}"
          echo "=== Dependency Check ==="
          echo "${{ needs.dependency-check.outputs.summary }}"

# ---------------------------
# 4️⃣ Release Build on Tag
# ---------------------------
  release-build:
    name: Build & Upload Release Binaries
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Build Linux amd64
        run: GOOS=linux GOARCH=amd64 go build -o GoMapper-linux-amd64 main.go

      - name: Build Linux 386
        run: GOOS=linux GOARCH=386 go build -o GoMapper-linux-x86 main.go

      - name: Build Windows amd64
        run: GOOS=windows GOARCH=amd64 go build -o GoMapper-windows-amd64.exe main.go

      - name: Build Windows 386
        run: GOOS=windows GOARCH=386 go build -o GoMapper-windows-x86.exe main.go

      - name: Create Source Archives
        run: |
          git archive -o GoMapper-source.zip HEAD
          git archive -o GoMapper-source.tar.gz --format=tar.gz HEAD

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GoMapper-linux-amd64
            GoMapper-linux-x86
            GoMapper-windows-amd64.exe
            GoMapper-windows-x86.exe
            GoMapper-source.zip
            GoMapper-source.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
