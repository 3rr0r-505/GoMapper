name: GoMapper CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types: [created]

jobs:

  # ==============================
  # 1️⃣ Security Scan (Commit / PR)
  # ==============================
  static-code-check:
    if: github.event_name != 'release'
    name: Static Code Check
    runs-on: ubuntu-latest
    outputs:
      lint-summary: ${{ steps.lint.outputs.summary }}
      vuln-summary: ${{ steps.vuln.outputs.summary }}
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Install Tools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          sudo apt-get update && sudo apt-get install -y jq

      # --------------------------
      # Run golangci-lint
      # --------------------------
      - name: Run golangci-lint
        id: lint
        run: |
          golangci-lint run ./... --out-format json > lint_report.json || true
          HIGH=$(jq '[.Issues[]? | select(.Severity=="error")] | length' lint_report.json)
          MEDIUM=$(jq '[.Issues[]? | select(.Severity=="warning")] | length' lint_report.json)
          LOW=0
          HIGH=${HIGH:-0}
          MEDIUM=${MEDIUM:-0}
          LOW=${LOW:-0}
          tmpfile=$(mktemp)
          echo "summary=High: $HIGH, Medium: $MEDIUM, Low: $LOW" > "$tmpfile"
          cat "$tmpfile" >> "$GITHUB_OUTPUT"
          rm "$tmpfile"

      # --------------------------
      # Run govulncheck
      # --------------------------
      - name: Run govulncheck
        id: vuln
        run: |
          govulncheck -json ./... > vuln_report.json || true
          if [ -s vuln_report.json ] && jq empty vuln_report.json 2>/dev/null; then
              HIGH=$(jq '[.Vulns[]? | select(.Severity=="HIGH")] | length' vuln_report.json)
              MEDIUM=$(jq '[.Vulns[]? | select(.Severity=="MEDIUM")] | length' vuln_report.json)
              LOW=$(jq '[.Vulns[]? | select(.Severity=="LOW")] | length' vuln_report.json)
          else
              HIGH=0
              MEDIUM=0
              LOW=0
          fi
          HIGH=${HIGH:-0}
          MEDIUM=${MEDIUM:-0}
          LOW=${LOW:-0}
          tmpfile=$(mktemp)
          echo "summary=High: $HIGH, Medium: $MEDIUM, Low: $LOW" > "$tmpfile"
          cat "$tmpfile" >> "$GITHUB_OUTPUT"
          rm "$tmpfile"

  # --------------------------
  # Combined Security Summary
  # --------------------------
  combined-summary:
    if: github.event_name != 'release'
    name: Combined Security Summary
    runs-on: ubuntu-latest
    needs:
      - static-code-check
    steps:
      - name: Show Combined Results
        run: |
          echo "=== GolangCI-Lint ==="
          echo "${{ needs.static-code-check.outputs.lint-summary }}"
          echo "=== Govulncheck ==="
          echo "${{ needs.static-code-check.outputs.vuln-summary }}"

  # ==============================
  # 2️⃣ Release Build (Tag Push)
  # ==============================
  release-build:
    if: github.event_name == 'release'
    name: Build GoMapper Binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Set version from tag
        id: version
        run: |
          echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Build Linux amd64
        run: |
          GOOS=linux GOARCH=amd64 go build -o GoMapper-linux-amd64 main.go

      - name: Build Linux 386
        run: |
          GOOS=linux GOARCH=386 go build -o GoMapper-linux-x86 main.go

      - name: Build Windows amd64
        run: |
          GOOS=windows GOARCH=amd64 go build -o GoMapper-windows-amd64.exe main.go

      - name: Build Windows 386
        run: |
          GOOS=windows GOARCH=386 go build -o GoMapper-windows-x86.exe main.go

      - name: Create Source Archives
        run: |
          zip -r GoMapper-source-${VERSION}.zip ./*
          tar -czf GoMapper-source-${VERSION}.tar.gz ./*

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GoMapper-linux-amd64
            GoMapper-linux-x86
            GoMapper-windows-amd64.exe
            GoMapper-windows-x86.exe
            GoMapper-source-${VERSION}.zip
            GoMapper-source-${VERSION}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
